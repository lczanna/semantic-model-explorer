var HyparquetWriter=(()=>{var J=Object.defineProperty;var Xe=Object.getOwnPropertyDescriptor;var Je=Object.getOwnPropertyNames;var Qe=Object.prototype.hasOwnProperty;var ve=(e,t)=>{for(var n in t)J(e,n,{get:t[n],enumerable:!0})},et=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let f of Je(t))!Qe.call(e,f)&&f!==n&&J(e,f,{get:()=>t[f],enumerable:!(r=Xe(t,f))||r.enumerable});return e};var tt=e=>et(J({},"__esModule",{value:!0}),e);var qt={};ve(qt,{ByteWriter:()=>_,ParquetWriter:()=>M,autoSchemaElement:()=>v,parquetWrite:()=>se,parquetWriteBuffer:()=>je,schemaFromColumnData:()=>j});function _(){return this.buffer=new ArrayBuffer(1024),this.view=new DataView(this.buffer),this.offset=0,this.index=0,this}_.prototype.ensure=function(e){if(this.index+e>this.buffer.byteLength){let t=Math.max(this.buffer.byteLength*2,this.index+e),n=new ArrayBuffer(t);new Uint8Array(n).set(new Uint8Array(this.buffer)),this.buffer=n,this.view=new DataView(this.buffer)}};_.prototype.finish=function(){};_.prototype.getBuffer=function(){return this.buffer.slice(0,this.index)};_.prototype.appendUint8=function(e){this.ensure(this.index+1),this.view.setUint8(this.index,e),this.offset++,this.index++};_.prototype.appendUint32=function(e){this.ensure(this.index+4),this.view.setUint32(this.index,e,!0),this.offset+=4,this.index+=4};_.prototype.appendInt32=function(e){this.ensure(this.index+4),this.view.setInt32(this.index,e,!0),this.offset+=4,this.index+=4};_.prototype.appendInt64=function(e){this.ensure(this.index+8),this.view.setBigInt64(this.index,BigInt(e),!0),this.offset+=8,this.index+=8};_.prototype.appendFloat32=function(e){this.ensure(this.index+8),this.view.setFloat32(this.index,e,!0),this.offset+=4,this.index+=4};_.prototype.appendFloat64=function(e){this.ensure(this.index+8),this.view.setFloat64(this.index,e,!0),this.offset+=8,this.index+=8};_.prototype.appendBuffer=function(e){this.appendBytes(new Uint8Array(e))};_.prototype.appendBytes=function(e){this.ensure(this.index+e.length),new Uint8Array(this.buffer,this.index,e.length).set(e),this.offset+=e.length,this.index+=e.length};_.prototype.appendVarInt=function(e){for(;;)if((e&-128)===0){this.appendUint8(e);return}else this.appendUint8(e&127|128),e>>>=7};_.prototype.appendVarBigInt=function(e){for(;;)if((e&~0x7fn)===0n){this.appendUint8(Number(e));return}else this.appendUint8(Number(e&0x7fn|0x80n)),e>>=7n};_.prototype.appendZigZag=function(e){typeof e=="number"?this.appendVarInt(e<<1^e>>31):this.appendVarBigInt(e<<1n^e>>63n)};function _e(e,t,n){let r=e[t],f=[],o=1;if(r.num_children)for(;f.length<r.num_children;){let i=e[t+o],s=_e(e,t+o,[...n,i.name]);o+=s.count,f.push(s)}return{count:o,element:r,children:f,path:n}}function K(e,t){let n=_e(e,0,[]),r=[n];for(let f of t){let o=n.children.find(i=>i.element.name===f);if(!o)throw new Error(`parquet schema element not found: ${t}`);r.push(o),n=o}return r}var Q=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],U=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],he=["REQUIRED","OPTIONAL","REPEATED"],me=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],ye=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],H=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],ge=["UNORDERED","ASCENDING","DESCENDING"];function N(e,t){let n=t.length;if(n===0){e.appendVarInt(128),e.appendVarInt(4),e.appendVarInt(0),e.appendVarInt(0);return}if(typeof t[0]!="number"&&typeof t[0]!="bigint")throw new Error("deltaBinaryPack only supports number or bigint arrays");e.appendVarInt(128),e.appendVarInt(4),e.appendVarInt(n),e.appendZigZag(t[0]);let r=1;for(;r<n;){let f=Math.min(r+128,n),o=f-r,i=new BigInt64Array(o),s=BigInt(t[r])-BigInt(t[r-1]);i[0]=s;for(let c=1;c<o;c++){let d=BigInt(t[r+c])-BigInt(t[r+c-1]);i[c]=d,d<s&&(s=d)}e.appendZigZag(s);let a=new Uint8Array(4);for(let c=0;c<4;c++){let d=c*32,E=Math.min(d+32,o),l=0n;for(let u=d;u<E;u++){let p=i[u]-s;p>l&&(l=p)}a[c]=nt(l)}e.appendBytes(a);for(let c=0;c<4;c++){let d=a[c];if(d===0)continue;let E=c*32,l=Math.min(E+32,o),u=0n,p=0;for(let m=0;m<32;m++){let L=E+m<l?i[E+m]-s:0n;for(u|=L<<BigInt(p),p+=d;p>=8;)e.appendUint8(Number(u&0xffn)),u>>=8n,p-=8}}r=f}}function Ee(e,t){let n=new Int32Array(t.length);for(let r=0;r<t.length;r++){let f=t[r];if(!(f instanceof Uint8Array))throw new Error("deltaLengthByteArray expects Uint8Array values");n[r]=f.length}N(e,n);for(let r of t)e.appendBytes(r)}function Ae(e,t){if(t.length===0){N(e,[]),N(e,[]);return}let n=new Int32Array(t.length),r=new Int32Array(t.length),f=new Array(t.length);if(!(t[0]instanceof Uint8Array))throw new Error("deltaByteArray expects Uint8Array values");n[0]=0,r[0]=t[0].length,f[0]=t[0];for(let i=1;i<t.length;i++){let s=t[i-1],a=t[i];if(!(a instanceof Uint8Array))throw new Error("deltaByteArray expects Uint8Array values");let c=0,d=Math.min(s.length,a.length);for(;c<d&&s[c]===a[c];)c++;n[i]=c,r[i]=a.length-c,f[i]=a.subarray(c)}N(e,n),N(e,r);for(let i of f)e.appendBytes(i)}function nt(e){if(e===0n)return 0;let t=0;for(;e>0n;)t++,e>>=1n;return t}function Y(e,t,n){let r=e.offset,f=new _;it(f,t,n);let o=new _;return rt(o,t,n),f.offset<o.offset?e.appendBuffer(f.getBuffer()):e.appendBuffer(o.getBuffer()),e.offset-r}function rt(e,t,n){let r=Math.ceil(t.length/8),f=r<<1|1;if(e.appendVarInt(f),n===0||t.length===0)return;let o=(1<<n)-1,i=0,s=0;for(let c=0;c<t.length;c++){let d=t[c]&o;for(i|=d<<s,s+=n;s>=8;)e.appendUint8(i&255),i>>>=8,s-=8}let a=r*8;for(let c=t.length;c<a;c++)for(i|=0<<s,s+=n;s>=8;)e.appendUint8(i&255),i>>>=8,s-=8;s>0&&e.appendUint8(i&255)}function it(e,t,n){if(!t.length)return;let r=t[0],f=1;for(let o=1;o<=t.length;o++)if(o<t.length&&t[o]===r)f++;else{let i=f<<1;e.appendVarInt(i);let s=n+7>>3;for(let a=0;a<s;a++)e.appendUint8(r>>(a<<3)&255);o<t.length&&(r=t[o],f=1)}}function W(e,t,n,r){if(n==="BOOLEAN")ot(e,t);else if(n==="INT32")ft(e,t);else if(n==="INT64")st(e,t);else if(n==="FLOAT")at(e,t);else if(n==="DOUBLE")ct(e,t);else if(n==="BYTE_ARRAY")lt(e,t);else if(n==="FIXED_LEN_BYTE_ARRAY"){if(!r)throw new Error("parquet FIXED_LEN_BYTE_ARRAY expected type_length");dt(e,t,r)}else throw new Error(`parquet unsupported type: ${n}`)}function ot(e,t){let n=0;for(let r=0;r<t.length;r++){if(typeof t[r]!="boolean")throw new Error("parquet expected boolean value");let f=r%8;t[r]&&(n|=1<<f),f===7&&(e.appendUint8(n),n=0)}t.length%8!==0&&e.appendUint8(n)}function ft(e,t){for(let n of t){if(!Number.isSafeInteger(n))throw new Error("parquet expected integer value");e.appendInt32(n)}}function st(e,t){for(let n of t){if(typeof n!="bigint")throw new Error("parquet expected bigint value");e.appendInt64(n)}}function at(e,t){for(let n of t){if(typeof n!="number")throw new Error("parquet expected number value");e.appendFloat32(n)}}function ct(e,t){for(let n of t){if(typeof n!="number")throw new Error("parquet expected number value");e.appendFloat64(n)}}function lt(e,t){for(let n of t){let r=n;if(typeof r=="string"&&(r=new TextEncoder().encode(n)),!(r instanceof Uint8Array))throw new Error("parquet expected Uint8Array value");e.appendUint32(r.length),e.appendBytes(r)}}function dt(e,t,n){for(let r of t){if(!(r instanceof Uint8Array))throw new Error("parquet expected Uint8Array value");if(r.length!==n)throw new Error(`parquet expected Uint8Array of length ${n}`);e.appendBytes(r)}}function j({columnData:e,schemaOverrides:t}){let n=[{name:"root",num_children:e.length}],r=0;for(let{name:f,data:o,type:i,nullable:s}of e){if(r=r||o.length,r!==o.length)throw new Error("columns must have the same length");if(t?.[f]){let a=t[f];if(a.name!==f)throw new Error("schema override name does not match column name");n.push(a)}else i?n.push(ut(f,i,s)):n.push(v(f,o))}return n}function ut(e,t,n){let r=n===!1?"REQUIRED":"OPTIONAL";return t==="STRING"?{name:e,type:"BYTE_ARRAY",converted_type:"UTF8",repetition_type:r}:t==="JSON"?{name:e,type:"BYTE_ARRAY",converted_type:"JSON",repetition_type:r}:t==="TIMESTAMP"?{name:e,type:"INT64",converted_type:"TIMESTAMP_MILLIS",repetition_type:r}:t==="UUID"?{name:e,type:"FIXED_LEN_BYTE_ARRAY",type_length:16,logical_type:{type:"UUID"},repetition_type:r}:t==="FLOAT16"?{name:e,type:"FIXED_LEN_BYTE_ARRAY",type_length:2,logical_type:{type:"FLOAT16"},repetition_type:r}:t==="GEOMETRY"?{name:e,type:"BYTE_ARRAY",logical_type:{type:"GEOMETRY"},repetition_type:r}:t==="GEOGRAPHY"?{name:e,type:"BYTE_ARRAY",logical_type:{type:"GEOGRAPHY"},repetition_type:r}:{name:e,type:t,repetition_type:r}}function v(e,t){let n,r="REQUIRED",f;if(t instanceof Int32Array)return{name:e,type:"INT32",repetition_type:r};if(t instanceof BigInt64Array)return{name:e,type:"INT64",repetition_type:r};if(t instanceof Float32Array)return{name:e,type:"FLOAT",repetition_type:r};if(t instanceof Float64Array)return{name:e,type:"DOUBLE",repetition_type:r};for(let o of t)if(o==null)r="OPTIONAL";else{let i;if(o===!0||o===!1)i="BOOLEAN";else if(typeof o=="bigint")i="INT64";else if(Number.isInteger(o))i="INT32";else if(typeof o=="number")i="DOUBLE";else if(o instanceof Uint8Array)i="BYTE_ARRAY";else if(typeof o=="string"){if(i="BYTE_ARRAY",n&&!f)throw new Error("mixed types not supported");f="UTF8"}else if(o instanceof Date){if(i="INT64",n&&!f)throw new Error("mixed types not supported");f="TIMESTAMP_MILLIS"}else if(typeof o=="object")f="JSON",i="BYTE_ARRAY";else if(!i)throw new Error(`cannot determine parquet type for: ${o}`);if(n===void 0?n=i:n==="INT32"&&i==="DOUBLE"?n="DOUBLE":n==="DOUBLE"&&i==="INT32"&&(i="DOUBLE"),n!==i)throw new Error(`parquet cannot write mixed types: ${n} and ${i}`)}return n||(n="BYTE_ARRAY",r="OPTIONAL"),{name:e,type:n,repetition_type:r,converted_type:f}}function Ie(e){let t=0;for(let n of e)n.repetition_type==="REPEATED"&&t++;return t}function we(e){let t=0;for(let n of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Te(e,t,n,r){let f=t.length,o,i;if(n==="FLOAT"){let s=t instanceof Float32Array?t:new Float32Array(ee(t));o=new Uint8Array(s.buffer,s.byteOffset,s.byteLength),i=4}else if(n==="DOUBLE"){let s=t instanceof Float64Array?t:new Float64Array(ee(t));o=new Uint8Array(s.buffer,s.byteOffset,s.byteLength),i=8}else if(n==="INT32"){let s=t instanceof Int32Array?t:new Int32Array(ee(t));o=new Uint8Array(s.buffer,s.byteOffset,s.byteLength),i=4}else if(n==="INT64"){let s=pt(t);o=new Uint8Array(s.buffer,s.byteOffset,s.byteLength),i=8}else if(n==="FIXED_LEN_BYTE_ARRAY"){if(!r)throw new Error("parquet byte_stream_split missing type_length");i=r,o=new Uint8Array(f*i);for(let s=0;s<f;s++)o.set(t[s],s*i)}else throw new Error(`parquet byte_stream_split unsupported type: ${n}`);for(let s=0;s<i;s++)for(let a=0;a<f;a++)e.appendUint8(o[a*i+s])}function ee(e){if(Array.isArray(e)&&e.every(t=>typeof t=="number"))return e;throw new Error("Expected number array for BYTE_STREAM_SPLIT encoding")}function pt(e){if(e instanceof BigInt64Array)return e;if(Array.isArray(e)&&e.every(t=>typeof t=="bigint"))return new BigInt64Array(e);throw new Error("Expected bigint array for BYTE_STREAM_SPLIT encoding")}var g={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function O(e,t){let n=0;for(let[r,f]of Object.entries(t)){if(f===void 0)continue;let o=parseInt(r.replace(/^field_/,""),10);if(Number.isNaN(o))throw new Error(`thrift invalid field name: ${r}. Expected "field_###".`);let i=te(f),s=o-n;if(s<=0)throw new Error(`thrift non-monotonic field ID: fid=${o}, lastFid=${n}`);s<=15?e.appendUint8(s<<4|i):(e.appendUint8(i),e.appendVarInt(o<<1^o>>15)),ne(e,i,f),n=o}e.appendUint8(g.STOP)}function te(e){if(e===!0)return g.TRUE;if(e===!1)return g.FALSE;if(Number.isInteger(e))return g.I32;if(typeof e=="number")return g.DOUBLE;if(typeof e=="bigint")return g.I64;if(typeof e=="string")return g.BINARY;if(e instanceof Uint8Array)return g.BINARY;if(Array.isArray(e))return g.LIST;if(e&&typeof e=="object")return g.STRUCT;throw new Error(`Cannot determine thrift compact type for: ${e}`)}function ne(e,t,n){if(t!==g.TRUE&&t!==g.FALSE)if(t===g.BYTE&&typeof n=="number")e.appendUint8(n);else if(t===g.I32&&typeof n=="number"){let r=n<<1^n>>31;e.appendVarInt(r)}else if(t===g.I64&&typeof n=="bigint"){let r=n<<1n^n>>63n;e.appendVarBigInt(r)}else if(t===g.DOUBLE&&typeof n=="number")e.appendFloat64(n);else if(t===g.BINARY&&typeof n=="string"){let r=new TextEncoder().encode(n);e.appendVarInt(r.length),e.appendBytes(r)}else if(t===g.BINARY&&n instanceof Uint8Array)e.appendVarInt(n.byteLength),e.appendBytes(n);else if(t===g.LIST&&Array.isArray(n)){let r=n.length;if(r===0){e.appendUint8(0|g.BYTE);return}let f=te(n[0]),o=r>14?15:r;if(e.appendUint8(o<<4|f),r>14&&e.appendVarInt(r),f===g.TRUE||f===g.FALSE)for(let i of n)e.appendUint8(i?1:0);else for(let i of n)ne(e,f,i)}else if(t===g.STRUCT&&typeof n=="object"){let r=0;for(let[f,o]of Object.entries(n)){if(o===void 0)continue;let i=parseInt(f.replace(/^field_/,""),10);if(Number.isNaN(i))throw new Error(`Invalid sub-field name: ${f}. Expected "field_###"`);let s=te(o),a=i-r;if(a<=0)throw new Error(`Non-monotonic fid in struct: fid=${i}, lastFid=${r}`);a<=15?e.appendUint8(a<<4|s):(e.appendUint8(s),e.appendVarInt(i<<1^i>>15)),ne(e,s,o),r=i}e.appendUint8(g.STOP)}else throw new Error(`unhandled type in writeElement: ${t} for value ${n}`)}function xe({writer:e,values:t,column:n,encoding:r,pageData:f}){let{columnName:o,element:i,codec:s,compressors:a}=n,{type:c,type_length:d,repetition_type:E}=i;if(!c)throw new Error(`column ${o} cannot determine type`);if(E==="REPEATED")throw new Error(`column ${o} repeated types not supported`);let l=new _,{definition_levels_byte_length:u,repetition_levels_byte_length:p,num_nulls:m,num_values:L,num_rows:x}=_t(l,n,f),y=t.filter(h=>h!=null),I=new _;if(r==="PLAIN")W(I,y,c,d);else if(r==="RLE"){if(c!=="BOOLEAN")throw new Error("RLE encoding only supported for BOOLEAN type");let h=new _;Y(h,y,1),I.appendUint32(h.offset),I.appendBuffer(h.getBuffer())}else if(r==="PLAIN_DICTIONARY"||r==="RLE_DICTIONARY"){let h=0;for(let T of t)T>h&&(h=T);let B=Math.ceil(Math.log2(h+1));I.appendUint8(B),Y(I,y,B)}else if(r==="DELTA_BINARY_PACKED"){if(c!=="INT32"&&c!=="INT64")throw new Error("DELTA_BINARY_PACKED encoding only supported for INT32 and INT64 types");N(I,y)}else if(r==="DELTA_LENGTH_BYTE_ARRAY"){if(c!=="BYTE_ARRAY")throw new Error("DELTA_LENGTH_BYTE_ARRAY encoding only supported for BYTE_ARRAY type");Ee(I,y)}else if(r==="DELTA_BYTE_ARRAY"){if(c!=="BYTE_ARRAY")throw new Error("DELTA_BYTE_ARRAY encoding only supported for BYTE_ARRAY type");Ae(I,y)}else if(r==="BYTE_STREAM_SPLIT")Te(I,y,c,d);else throw new Error(`parquet unsupported encoding: ${r}`);let A=new Uint8Array(I.getBuffer()),w=a[s]?.(A)??A;re(e,{type:"DATA_PAGE_V2",uncompressed_page_size:l.offset+I.offset,compressed_page_size:l.offset+w.length,data_page_header_v2:{num_values:L,num_nulls:m,num_rows:x,encoding:r,definition_levels_byte_length:u,repetition_levels_byte_length:p,is_compressed:!!s}}),e.appendBuffer(l.getBuffer()),e.appendBytes(w)}function re(e,t){let n={field_1:H.indexOf(t.type),field_2:t.uncompressed_page_size,field_3:t.compressed_page_size,field_4:t.crc,field_5:t.data_page_header&&{field_1:t.data_page_header.num_values,field_2:U.indexOf(t.data_page_header.encoding),field_3:U.indexOf(t.data_page_header.definition_level_encoding),field_4:U.indexOf(t.data_page_header.repetition_level_encoding)},field_7:t.dictionary_page_header&&{field_1:t.dictionary_page_header.num_values,field_2:U.indexOf(t.dictionary_page_header.encoding)},field_8:t.data_page_header_v2&&{field_1:t.data_page_header_v2.num_values,field_2:t.data_page_header_v2.num_nulls,field_3:t.data_page_header_v2.num_rows,field_4:U.indexOf(t.data_page_header_v2.encoding),field_5:t.data_page_header_v2.definition_levels_byte_length,field_6:t.data_page_header_v2.repetition_levels_byte_length,field_7:t.data_page_header_v2.is_compressed?void 0:!1}};O(e,n)}function _t(e,t,n){let{schemaPath:r}=t,{values:f,definitionLevels:o,repetitionLevels:i,numNulls:s,maxDefinitionLevel:a}=n,c=i.length?i.reduce((p,m)=>m===0?p+1:p,0):f.length,d=o.length||f.length,E=Ie(r),l=0;if(E){let p=Math.ceil(Math.log2(E+1));l=Y(e,i,p)}let u=0;if(a){let p=Math.ceil(Math.log2(a+1));u=Y(e,o,p)}return{definition_levels_byte_length:u,repetition_levels_byte_length:l,num_nulls:s,num_values:d,num_rows:c}}function Be(e){let t=new Set,n;for(let r of e)if(r!=null){if(typeof r!="object")throw new Error("geospatial column expects GeoJSON geometries");n=Le(n,r),t.add(mt(r))}if(t.size||n)return{bbox:n,geospatial_types:t.size?Array.from(t).sort((r,f)=>r-f):[]}}function Le(e,t){if(t.type==="GeometryCollection"){for(let n of t.geometries||[])e=Le(e,n);return e}return Re(e,t.coordinates)}function Re(e,t){if(typeof t[0]=="number")return ht(e,t);for(let n of t)e=Re(e,n);return e}function ht(e,t){let n=t[0],r=t[1];return!Number.isFinite(n)||!Number.isFinite(r)||(e?(Z(e,"xmin","xmax",n),Z(e,"ymin","ymax",r)):e={xmin:n,ymin:r,xmax:n,ymax:r},t.length>2&&Z(e,"zmin","zmax",t[2]),t.length>3&&Z(e,"mmin","mmax",t[3])),e}function Z(e,t,n,r){r===void 0||!Number.isFinite(r)||((e[t]===void 0||r<e[t])&&(e[t]=r),(e[n]===void 0||r>e[n])&&(e[n]=r))}function mt(e){let t=yt[e.type];if(t===void 0)throw new Error(`unknown geometry type: ${e.type}`);let n=Ue(e);if(n===2)return t;if(n===3)return t+1e3;if(n===4)return t+3e3;throw new Error(`unsupported geometry dimensions: ${n}`)}var yt={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6,GeometryCollection:7};function Ue(e){if(e.type==="GeometryCollection"){let t=0;for(let n of e.geometries||[])t=Math.max(t,Ue(n));return t||2}return be(e.coordinates)}function be(e){if(!e.length)return 2;if(typeof e[0]=="number")return e.length;let t=0;for(let n of e)t=Math.max(t,be(n));return t||2}function F(e){if(e===void 0)return null;if(typeof e=="bigint")return Number(e);if(Object.is(e,-0))return 0;if(Array.isArray(e))return e.map(F);if(e instanceof Uint8Array)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof Object){let t={};for(let n of Object.keys(e))e[n]!==void 0&&(t[n]=F(e[n]));return t}return e}function Oe(e){let t=new _;return V(t,e),new Uint8Array(t.getBuffer())}function V(e,t){let n=gt(t.type),r=Se(t),f=0;if(r===3)f=1;else if(r===4)f=3;else if(r>4)throw new Error(`unsupported geometry dimensions: ${r}`);if(e.appendUint8(1),e.appendUint32(n+f*1e3),t.type==="Point")De(e,t.coordinates,r);else if(t.type==="LineString")Ne(e,t.coordinates,r);else if(t.type==="Polygon"){e.appendUint32(t.coordinates.length);for(let o of t.coordinates)Ne(e,o,r)}else if(t.type==="MultiPoint"){e.appendUint32(t.coordinates.length);for(let o of t.coordinates)V(e,{type:"Point",coordinates:o})}else if(t.type==="MultiLineString"){e.appendUint32(t.coordinates.length);for(let o of t.coordinates)V(e,{type:"LineString",coordinates:o})}else if(t.type==="MultiPolygon"){e.appendUint32(t.coordinates.length);for(let o of t.coordinates)V(e,{type:"Polygon",coordinates:o})}else if(t.type==="GeometryCollection"){e.appendUint32(t.geometries.length);for(let o of t.geometries)V(e,o)}else throw new Error("unsupported geometry type")}function De(e,t,n){if(t.length<n)throw new Error("geometry position dimensions mismatch");for(let r=0;r<n;r++)e.appendFloat64(t[r])}function Ne(e,t,n){e.appendUint32(t.length);for(let r of t)De(e,r,n)}function gt(e){if(e==="Point")return 1;if(e==="LineString")return 2;if(e==="Polygon")return 3;if(e==="MultiPoint")return 4;if(e==="MultiLineString")return 5;if(e==="MultiPolygon")return 6;if(e==="GeometryCollection")return 7;throw new Error(`unknown geometry type: ${e}`)}function Se(e){if(e.type==="GeometryCollection"){let t=0;for(let n of e.geometries)t=Math.max(t,Se(n));return t||2}return Pe(e.coordinates)}function Pe(e){if(!Array.isArray(e)||!e.length)return 2;if(typeof e[0]=="number")return e.length;let t=0;for(let n of e)t=Math.max(t,Pe(n));return t||2}var Me=864e5;function ie(e,t){let{type:n,converted_type:r,logical_type:f}=e;if(r==="DECIMAL"){let o=10**(e.scale||0);return t.map(i=>{if(i==null)return i;if(typeof i!="number")throw new Error("DECIMAL must be a number");return Ye(e,BigInt(Math.round(i*o)))})}if(r==="DATE")return Array.from(t).map(o=>o&&o.getTime()/Me);if(r==="TIMESTAMP_MILLIS")return Array.from(t).map(o=>o&&BigInt(o.getTime()));if(r==="TIMESTAMP_MICROS")return Array.from(t).map(o=>o&&BigInt(o.getTime()*1e3));if(r==="JSON"){if(!Array.isArray(t))throw new Error("JSON must be an array");let o=new TextEncoder;return t.map(i=>i===void 0?void 0:o.encode(JSON.stringify(F(i))))}if(r==="UTF8"){if(!Array.isArray(t))throw new Error("strings must be an array");let o=new TextEncoder;return t.map(i=>typeof i=="string"?o.encode(i):i)}if(f?.type==="FLOAT16"){if(n!=="FIXED_LEN_BYTE_ARRAY")throw new Error("FLOAT16 must be FIXED_LEN_BYTE_ARRAY type");if(e.type_length!==2)throw new Error("FLOAT16 expected type_length to be 2 bytes");return Array.from(t).map(At)}if(f?.type==="UUID"){if(!Array.isArray(t))throw new Error("UUID must be an array");if(n!=="FIXED_LEN_BYTE_ARRAY")throw new Error("UUID must be FIXED_LEN_BYTE_ARRAY type");if(e.type_length!==16)throw new Error("UUID expected type_length to be 16 bytes");return t.map(Et)}if(f?.type==="GEOMETRY"||f?.type==="GEOGRAPHY"){if(!Array.isArray(t))throw new Error("geometry must be an array");return t.map(o=>o&&Oe(o))}return t}function Et(e){if(e!=null){if(e instanceof Uint8Array)return e;if(typeof e=="string"){if(!/^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$/i.test(e))throw new Error("UUID must be a valid UUID string");e=e.replace(/-/g,"").toLowerCase();let n=new Uint8Array(16);for(let r=0;r<16;r++)n[r]=parseInt(e.slice(r*2,r*2+2),16);return n}throw new Error("UUID must be a string or Uint8Array")}}function D(e,t){if(e==null)return;let{type:n,converted_type:r}=t;if(n==="BOOLEAN")return new Uint8Array([e?1:0]);if(r==="DECIMAL"){if(typeof e!="number")throw new Error("DECIMAL must be a number");let f=10**(t.scale||0),o=Ye(t,BigInt(Math.round(e*f)));if(o instanceof Uint8Array)return o;if(typeof o=="number"){let i=new ArrayBuffer(4);return new DataView(i).setFloat32(0,o,!0),new Uint8Array(i)}if(typeof o=="bigint"){let i=new ArrayBuffer(8);return new DataView(i).setBigInt64(0,o,!0),new Uint8Array(i)}}if(n==="BYTE_ARRAY"||n==="FIXED_LEN_BYTE_ARRAY")return e instanceof Uint8Array?e.slice(0,16):new TextEncoder().encode(e.toString().slice(0,16));if(n==="FLOAT"&&typeof e=="number"){let f=new ArrayBuffer(4);return new DataView(f).setFloat32(0,e,!0),new Uint8Array(f)}if(n==="DOUBLE"&&typeof e=="number"){let f=new ArrayBuffer(8);return new DataView(f).setFloat64(0,e,!0),new Uint8Array(f)}if(n==="INT32"&&typeof e=="number"){let f=new ArrayBuffer(4);return new DataView(f).setInt32(0,e,!0),new Uint8Array(f)}if(n==="INT64"&&typeof e=="bigint"){let f=new ArrayBuffer(8);return new DataView(f).setBigInt64(0,e,!0),new Uint8Array(f)}if(n==="INT32"&&r==="DATE"&&e instanceof Date){let f=new ArrayBuffer(4);return new DataView(f).setInt32(0,Math.floor(e.getTime()/Me),!0),new Uint8Array(f)}if(n==="INT64"&&r==="TIMESTAMP_MILLIS"&&e instanceof Date){let f=new ArrayBuffer(8);return new DataView(f).setBigInt64(0,BigInt(e.getTime()),!0),new Uint8Array(f)}throw new Error(`unsupported type for statistics: ${n} with value ${e}`)}function Ce(e,t){return{field_1:D(e.max,t),field_2:D(e.min,t),field_3:e.null_count,field_4:e.distinct_count,field_5:D(e.max_value,t),field_6:D(e.min_value,t),field_7:e.is_max_value_exact,field_8:e.is_min_value_exact}}function Ye({type:e,type_length:t},n){if(e==="INT32")return Number(n);if(e==="INT64")return n;if(e==="FIXED_LEN_BYTE_ARRAY"&&!t)throw new Error("fixed length byte array type_length is required");if(!t&&!n)return new Uint8Array;let r=[];for(;;){let f=Number(n&0xffn);if(r.unshift(f),n>>=8n,t){if(r.length>=t)break}else{let o=f&128;if(!o&&n===0n||o&&n===-1n)break}}return new Uint8Array(r)}function At(e){if(e==null)return;if(typeof e!="number")throw new Error("parquet float16 expected number value");if(Number.isNaN(e))return new Uint8Array([0,126]);let t=e<0||Object.is(e,-0)?1:0,n=Math.abs(e);if(!isFinite(n))return new Uint8Array([0,t<<7|124]);if(n===0)return new Uint8Array([0,t<<7]);let r=new ArrayBuffer(4);new Float32Array(r)[0]=n;let f=new Uint32Array(r)[0],o=f>>>23&255,i=f&8388607;if(o-=127,o<-14){let c=-14-o;i=(i|8388608)>>c+13,i&1&&(i+=1);let d=t<<15|i;return new Uint8Array([d&255,d>>8])}if(o>15)return new Uint8Array([0,t<<7|124]);let s=o+15;if(i=i+4096,i&8388608&&(i=0,++s===31))return new Uint8Array([0,t<<7|124]);let a=t<<15|s<<10|i>>13;return new Uint8Array([a&255,a>>8])}function Ve({writer:e,column:t,values:n,pageData:r}){let{columnName:f,element:o,schemaPath:i,stats:s,pageSize:a,encoding:c}=t,{type:d,type_length:E}=o;if(!d)throw new Error(`column ${f} cannot determine type`);let l=e.offset,u=n.length,p=[],m=o?.logical_type?.type==="GEOMETRY"||o?.logical_type?.type==="GEOGRAPHY",L=s?Fe(n):void 0,x=s&&m?Be(n):void 0,y,I=BigInt(e.offset),A=xt(n,d,c),w,h;if(A){let R=new Array(n.length);for(let b=0;b<n.length;b++)n[b]!==null&&n[b]!==void 0&&(R[b]=A.indexOf(n[b]));h=R,w="RLE_DICTIONARY",y=BigInt(e.offset);let C=ie(o,A);Bt(e,t,C)}else h=ie(o,n),w=c??(d==="BOOLEAN"&&n.length>16?"RLE":"PLAIN");p.push(w);let B=It(h,d,E,a),T=t.columnIndex?{null_pages:[],min_values:[],max_values:[],boundary_order:"UNORDERED",null_counts:[]}:void 0,S=t.offsetIndex?{page_locations:[]}:void 0;I=BigInt(e.offset);let P=0n,z,ae=!0,ce=!0;for(let{start:R,end:C}of B){let b=wt(h,r,R,C),le=e.offset;xe({writer:e,column:t,encoding:w,...b});let de=BigInt(C-R);if(T){let Ze=n.slice(R,C),X=Fe(Ze),ue=X.null_count??0n;T.null_pages.push(ue===de);let G=D(X.min_value,o),pe=D(X.max_value,o);T.min_values.push(G??0),T.max_values.push(pe??0),T.null_counts?.push(ue),z!==void 0&&G!==void 0&&(z>G&&(ae=!1),z<G&&(ce=!1)),z=pe}S&&S.page_locations.push({offset:BigInt(le),compressed_page_size:e.offset-le,first_row_index:BigInt(P)}),P+=de}if(T){let R=T.min_values.length;T.boundary_order=R<2?"UNORDERED":ae?"ASCENDING":ce?"DESCENDING":"UNORDERED"}return{chunk:{meta_data:{type:d,encodings:p,path_in_schema:i.slice(1).map(R=>R.name),codec:t.codec??"UNCOMPRESSED",num_values:BigInt(u),total_compressed_size:BigInt(e.offset-l),total_uncompressed_size:BigInt(e.offset-l),data_page_offset:I,dictionary_page_offset:y,statistics:L,geospatial_statistics:x},file_offset:BigInt(l)},columnIndex:T,offsetIndex:S}}function It(e,t,n,r){if(!r)return[{start:0,end:e.length}];let f=[],o=0,i=0;for(let s=0;s<e.length;s++){let a=Tt(e[s],t,n);i+=a,i>=r&&s>o&&(f.push({start:o,end:s}),o=s,i=a)}return o<e.length&&f.push({start:o,end:e.length}),f}function wt(e,t,n,r){let f=e.slice(n,r),o=t.definitionLevels.slice(n,r),{maxDefinitionLevel:i}=t;return{values:f,pageData:{values:f,definitionLevels:o,repetitionLevels:t.repetitionLevels.slice(n,r),numNulls:o.reduce((s,a)=>a<i?s+1:s,0),maxDefinitionLevel:i}}}function Tt(e,t,n){if(e==null)return 0;if(t==="BOOLEAN")return 1;if(t==="INT32"||t==="FLOAT")return 4;if(t==="INT64"||t==="DOUBLE")return 8;if(t==="INT96")return 12;if(t==="FIXED_LEN_BYTE_ARRAY")return n??0;if(t==="BYTE_ARRAY"){if(e instanceof Uint8Array)return e.byteLength;if(typeof e=="string")return e.length}return 0}function xt(e,t,n){if(n&&n!=="RLE_DICTIONARY"||t==="BOOLEAN")return;let r=new Set(e);if(r.delete(void 0),r.delete(null),r.size!==0&&e.length/r.size>2)return Array.from(r)}function Bt(e,t,n){let{element:r,codec:f,compressors:o}=t,{type:i,type_length:s}=r;if(!i)throw new Error(`column ${t.columnName} cannot determine type`);let a=new _;W(a,n,i,s);let c=a,d=o?.[f];if(d){let E=new Uint8Array(a.getBuffer()),l=d(E);c=new _,c.appendBytes(l)}re(e,{type:"DICTIONARY_PAGE",uncompressed_page_size:a.offset,compressed_page_size:c.offset,dictionary_page_header:{num_values:n.length,encoding:"PLAIN"}}),e.appendBuffer(c.getBuffer())}function Fe(e){let t,n,r=0n;for(let f of e){if(f==null){r++;continue}typeof f!="object"&&((t===void 0||f<t)&&(t=f),(n===void 0||f>n)&&(n=f))}return{min_value:t,max_value:n,null_count:r}}function ke(e,t){if(e.length<2)throw new Error("parquet schema path must include column");let n=we(e);if(e.length===2&&n===0)return{values:t,definitionLevels:[],repetitionLevels:[],numNulls:0,maxDefinitionLevel:0};let r=[],f=[],o=[],i=new Array(e.length),s=0;for(let l=0;l<e.length;l++)i[l]=s,e[l].repetition_type==="REPEATED"&&s++;let a=e.length-1;for(let l=0;l<t.length;l++)d(1,t[l],0,0,!1);let c=f.reduce((l,u)=>u===n?l:l+1,0);return{values:r,definitionLevels:f,repetitionLevels:o,numNulls:c,maxDefinitionLevel:n};function d(l,u,p,m,L){let x=e[l],y=x.repetition_type||"REQUIRED";if(l===a){if(u==null){if(y==="REQUIRED"&&!L)throw new Error("parquet required value is undefined");f.push(p),o.push(m),r.push(null)}else{let A=y==="REQUIRED"?p:p+1;f.push(A),o.push(m),r.push(u)}return}if(y==="REPEATED"){if(u==null){if(!L)throw new Error("parquet required value is undefined");d(l+1,void 0,p,m,!0);return}if(!Array.isArray(u))throw new Error(`parquet repeated field ${x.name} must be an array`);if(!u.length){d(l+1,void 0,p,m,!0);return}let A=e[l-1]?.converted_type==="MAP",w=e[l+1];for(let h=0;h<u.length;h++){let B=u[h];A&&B&&typeof B=="object"&&w&&(B=B[w.name]);let T=h===0?m:i[l]+1;d(l+1,B,p+1,T,!1)}return}if(y==="OPTIONAL"){if(u==null)d(l+1,void 0,p,m,!0);else{let A=E(l,u),w=A==null,h=x?.converted_type==="LIST"||x?.converted_type==="MAP",T=x.num_children&&!x.type&&!h||!w?p+1:p;d(l+1,w?void 0:A,T,m,w)}return}if(u==null){if(!L)throw new Error("parquet required value is undefined");d(l+1,void 0,p,m,!0)}else d(l+1,E(l,u),p,m,!1)}function E(l,u){if(u==null)return;let p=e[l+1];if(!p)return;let m=e[l];if(m?.converted_type==="LIST"&&p.name==="list"||m?.converted_type==="MAP")return u;if(typeof u=="object")return u[p.name]}}function k(e,t){if(t==null)return t;if(Ut(e)){if(!Array.isArray(t))throw new Error(`parquet list field ${e.element.name} must be an array`);let n=e.children[0],r=n.children.length===1?n.children[0]:n;return t.map(f=>k(r,f))}if(bt(e))return Lt(e,t);if(e.children.length){if(typeof t!="object"||Array.isArray(t))throw new Error(`parquet struct field ${e.element.name} must be an object`);let n={};for(let r of e.children){let f=r.element.name;if(r.element.repetition_type==="REQUIRED"&&(t[f]===null||t[f]===void 0))throw new Error("parquet required value is undefined");n[f]=k(r,t[f])}return n}return t}function Lt(e,t){if(t==null)return t;let n=e.children[0];if(!n)throw new Error("parquet map missing entry node");let r=n.children[0],f=n.children[1],o;if(t instanceof Map)o=Array.from(t.entries()).map(([i,s])=>({key:i,value:s}));else if(Array.isArray(t))o=t.map(i=>{if(i&&typeof i=="object"&&"key"in i&&"value"in i)return{key:i.key,value:i.value};if(Array.isArray(i)&&i.length===2)return{key:i[0],value:i[1]};throw new Error("parquet map entry must provide key and value")});else if(typeof t=="object")o=Object.entries(t).map(([i,s])=>({key:i,value:s}));else throw new Error(`parquet map field ${e.element.name} must be Map, array, or object`);return o.map(({key:i,value:s})=>({key:Rt(r.element,i),value:k(f,s)}))}function Rt(e,t){if(t==null||!e?.type)return t;if(e.type==="INT32"){let n=-2147483648n,r=2147483647n;if(typeof t=="bigint"){if(t<n||t>r)throw new Error("parquet map key must be a 32-bit integer");return Number(t)}let f=Number(t);if(!Number.isFinite(f))throw new Error("parquet map key must be a finite number");if(!Number.isInteger(f)||f<Number(n)||f>Number(r))throw new Error("parquet map key must be a 32-bit integer");return f}if(e.type==="INT64")try{return typeof t=="bigint"?t:BigInt(t)}catch{throw new Error("parquet map key must be a bigint-compatible value")}return t}function Ut(e){return!e||e.element.converted_type!=="LIST"||e.children.length!==1?!1:e.children[0].element.repetition_type==="REPEATED"}function bt(e){if(!e||e.element.converted_type!=="MAP"||e.children.length!==1)return!1;let t=e.children[0];return t.children.length!==2?!1:t.element.repetition_type==="REPEATED"}function qe(e,t){for(let{chunk:n,columnIndex:r}of t)Nt(e,n,r);for(let{chunk:n,offsetIndex:r}of t)Ot(e,n,r)}function Nt(e,t,n){if(!n||n.min_values.length<=1)return;let r=e.offset;O(e,{field_1:n.null_pages,field_2:n.min_values,field_3:n.max_values,field_4:ge.indexOf(n.boundary_order),field_5:n.null_counts}),t.column_index_offset=BigInt(r),t.column_index_length=e.offset-r}function Ot(e,t,n){if(!n||n.page_locations.length<=1)return;let r=e.offset;O(e,{field_1:n.page_locations.map(f=>({field_1:f.offset,field_2:f.compressed_page_size,field_3:f.first_row_index}))}),t.offset_index_offset=BigInt(r),t.offset_index_length=e.offset-r}function ze(e,t){let n={field_1:t.version,field_2:t.schema&&t.schema.map(o=>({field_1:o.type&&Q.indexOf(o.type),field_2:o.type_length,field_3:o.repetition_type&&he.indexOf(o.repetition_type),field_4:o.name,field_5:o.num_children,field_6:o.converted_type&&me.indexOf(o.converted_type),field_7:o.scale,field_8:o.precision,field_9:o.field_id,field_10:St(o.logical_type)})),field_3:t.num_rows,field_4:t.row_groups.map(o=>({field_1:o.columns.map((i,s)=>({field_1:i.file_path,field_2:i.file_offset,field_3:i.meta_data&&{field_1:Q.indexOf(i.meta_data.type),field_2:i.meta_data.encodings.map(a=>U.indexOf(a)),field_3:i.meta_data.path_in_schema,field_4:ye.indexOf(i.meta_data.codec),field_5:i.meta_data.num_values,field_6:i.meta_data.total_uncompressed_size,field_7:i.meta_data.total_compressed_size,field_8:i.meta_data.key_value_metadata&&i.meta_data.key_value_metadata.map(a=>({field_1:a.key,field_2:a.value})),field_9:i.meta_data.data_page_offset,field_10:i.meta_data.index_page_offset,field_11:i.meta_data.dictionary_page_offset,field_12:i.meta_data.statistics&&Ce(i.meta_data.statistics,Dt(t.schema,i.meta_data.path_in_schema,s+1)),field_13:i.meta_data.encoding_stats&&i.meta_data.encoding_stats.map(a=>({field_1:H.indexOf(a.page_type),field_2:U.indexOf(a.encoding),field_3:a.count})),field_14:i.meta_data.bloom_filter_offset,field_15:i.meta_data.bloom_filter_length,field_16:i.meta_data.size_statistics&&{field_1:i.meta_data.size_statistics.unencoded_byte_array_data_bytes,field_2:i.meta_data.size_statistics.repetition_level_histogram,field_3:i.meta_data.size_statistics.definition_level_histogram},field_17:i.meta_data.geospatial_statistics&&{field_1:i.meta_data.geospatial_statistics.bbox&&{field_1:i.meta_data.geospatial_statistics.bbox.xmin,field_2:i.meta_data.geospatial_statistics.bbox.xmax,field_3:i.meta_data.geospatial_statistics.bbox.ymin,field_4:i.meta_data.geospatial_statistics.bbox.ymax,field_5:i.meta_data.geospatial_statistics.bbox.zmin,field_6:i.meta_data.geospatial_statistics.bbox.zmax,field_7:i.meta_data.geospatial_statistics.bbox.mmin,field_8:i.meta_data.geospatial_statistics.bbox.mmax},field_2:i.meta_data.geospatial_statistics.geospatial_types}},field_4:i.offset_index_offset,field_5:i.offset_index_length,field_6:i.column_index_offset,field_7:i.column_index_length,field_9:i.encrypted_column_metadata})),field_2:o.total_byte_size,field_3:o.num_rows,field_4:o.sorting_columns&&o.sorting_columns.map(i=>({field_1:i.column_idx,field_2:i.descending,field_3:i.nulls_first})),field_5:o.file_offset,field_6:o.total_compressed_size})),field_5:t.key_value_metadata&&t.key_value_metadata.map(o=>({field_1:o.key,field_2:o.value})),field_6:t.created_by},r=e.offset;O(e,n);let f=e.offset-r;e.appendUint32(f)}function Dt(e,t,n){if(t?.length){let r=K(e,t).at(-1)?.element;if(r)return r}return e[n]}function St(e){if(e){if(e.type==="STRING")return{field_1:{}};if(e.type==="MAP")return{field_2:{}};if(e.type==="LIST")return{field_3:{}};if(e.type==="ENUM")return{field_4:{}};if(e.type==="DECIMAL")return{field_5:{field_1:e.scale,field_2:e.precision}};if(e.type==="DATE")return{field_6:{}};if(e.type==="TIME")return{field_7:{field_1:e.isAdjustedToUTC,field_2:$e(e.unit)}};if(e.type==="TIMESTAMP")return{field_8:{field_1:e.isAdjustedToUTC,field_2:$e(e.unit)}};if(e.type==="INTEGER")return{field_10:{field_1:e.bitWidth,field_2:e.isSigned}};if(e.type==="NULL")return{field_11:{}};if(e.type==="JSON")return{field_12:{}};if(e.type==="BSON")return{field_13:{}};if(e.type==="UUID")return{field_14:{}};if(e.type==="FLOAT16")return{field_15:{}};if(e.type==="VARIANT")return{field_16:{}};if(e.type==="GEOMETRY")return{field_17:{field_1:e.crs}};if(e.type==="GEOGRAPHY")return{field_18:{field_1:e.crs,field_2:e.algorithm&&Pt[e.algorithm]}}}}function $e(e){return e==="NANOS"?{field_3:{}}:e==="MICROS"?{field_2:{}}:{field_1:{}}}var Pt={SPHERICAL:0,VINCENTY:1,THOMAS:2,ANDOYER:3,KARNEY:4};var Mt=16,Ct=1<<Mt,He=14,oe=new Array(He+1);function We(e){let t=new _;if(t.appendVarInt(e.length),e.length===0)return new Uint8Array(t.getBuffer());let n=0;for(;n<e.length;){let r=Math.min(e.length-n,Ct);Ft(e,n,r,t),n+=r}return new Uint8Array(t.getBuffer())}function q(e,t){return e*506832829>>>t}function $(e,t){return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)}function Ge(e,t,n){return e[t]===e[n]&&e[t+1]===e[n+1]&&e[t+2]===e[n+2]&&e[t+3]===e[n+3]}function Ke(e,t,n,r){n<=60?r.appendUint8(n-1<<2):n<256?(r.appendUint8(240),r.appendUint8(n-1)):(r.appendUint8(244),r.appendUint8(n-1&255),r.appendUint8(n-1>>>8)),r.appendBytes(e.subarray(t,t+n))}function fe(e,t,n){n<12&&t<2048?(e.appendUint8(1+(n-4<<2)+(t>>>8<<5)),e.appendUint8(t&255)):(e.appendUint8(2+(n-1<<2)),e.appendUint8(t&255),e.appendUint8(t>>>8))}function Yt(e,t,n){for(;n>=68;)fe(e,t,64),n-=64;n>64&&(fe(e,t,60),n-=60),fe(e,t,n)}function Ft(e,t,n,r){let f=1;for(;1<<f<=n&&f<=He;)f+=1;f-=1;let o=32-f;typeof oe[f]>"u"&&(oe[f]=new Uint16Array(1<<f));let i=oe[f];i.fill(0);let s=t+n,a,c=t,d=t,E,l,u,p,m,L,x,y,I,A,w,h=!0,B=15;if(n>=B)for(a=s-B,t+=1,l=q($(e,t),o);h;){m=32,u=t;do{if(t=u,E=l,L=m>>>5,m+=1,u=t+L,t>a){h=!1;break}l=q($(e,u),o),p=c+i[E],i[E]=t-c}while(!Ge(e,t,p));if(!h)break;Ke(e,d,t-d,r);do{for(x=t,y=4;t+y<s&&e[t+y]===e[p+y];)y++;if(t+=y,I=x-p,Yt(r,I,y),d=t,t>=a){h=!1;break}A=q($(e,t-1),o),i[A]=t-1-c,w=q($(e,t),o),p=c+i[w],i[w]=t-c}while(Ge(e,t,p));if(!h)break;t+=1,l=q($(e,t),o)}d<s&&Ke(e,d,s-d,r)}function M({writer:e,schema:t,codec:n="SNAPPY",compressors:r,statistics:f=!0,kvMetadata:o}){this.writer=e,this.schema=t,this.codec=n,this.compressors={SNAPPY:We,...r},this.statistics=f,this.kvMetadata=o,this.row_groups=[],this.num_rows=0n,this.pendingIndexes=[],this.writer.appendUint32(827474256)}M.prototype.write=function({columnData:e,rowGroupSize:t=[100,1e3,1e4],pageSize:n=1048576}){let r=e[0]?.data?.length||0;for(let{groupStartIndex:f,groupSize:o}of Vt({columnDataRows:r,rowGroupSize:t})){let i=this.writer.offset,s=[];for(let a=0;a<e.length;a++){let{name:c,data:d,encoding:E,columnIndex:l=!1,offsetIndex:u=!1}=e[a],p=d.slice(f,f+o),m=K(this.schema,[c]),L=kt(m),x=m.at(-1),y=x?Array.from(p,I=>k(x,I)):Array.from(p);for(let I of L){let A=I.map(P=>P.element),w=A.at(-1);if(!w)throw new Error(`parquet column ${c} missing schema element`);let h=ke(A,y),B=h.values,T={columnName:A.length===2?c:A.slice(1).map(P=>P.name).join("."),element:w,schemaPath:A,codec:this.codec,compressors:this.compressors,stats:this.statistics,pageSize:n,columnIndex:l,offsetIndex:u,encoding:E},S=Ve({writer:this.writer,column:T,values:B,pageData:h});s.push(S.chunk),this.pendingIndexes.push(S)}}this.num_rows+=BigInt(o),this.row_groups.push({columns:s,total_byte_size:BigInt(this.writer.offset-i),num_rows:BigInt(o)})}};M.prototype.finish=function(){qe(this.writer,this.pendingIndexes);let e={version:2,created_by:"hyparquet",schema:this.schema,num_rows:this.num_rows,row_groups:this.row_groups,metadata_length:0,key_value_metadata:this.kvMetadata};delete e.metadata_length,ze(this.writer,e),this.writer.appendUint32(827474256),this.writer.finish()};function Vt({columnDataRows:e,rowGroupSize:t}){if(Array.isArray(t)&&!t.length)throw new Error("rowGroupSize array cannot be empty");let n=[],r=0,f=0;for(;f<e;){let o=Array.isArray(t)?t[Math.min(r,t.length-1)]:t,i=Math.min(o,e-f);n.push({groupStartIndex:f,groupSize:i}),f+=o,r++}return n}function kt(e){let t=[];return n([...e]),t;function n(r){let f=r[r.length-1];if(!f.children.length){t.push(r);return}for(let o of f.children)n([...r,o])}}function se({writer:e,columnData:t,schema:n,codec:r="SNAPPY",compressors:f,statistics:o=!0,rowGroupSize:i=[100,1e3,1e4],kvMetadata:s,pageSize:a=1048576}){if(!n)n=j({columnData:t});else if(t.some(({type:d})=>d))throw new Error("cannot provide both schema and columnData type");let c=new M({writer:e,schema:n,codec:r,compressors:f,statistics:o,kvMetadata:s});c.write({columnData:t,rowGroupSize:i,pageSize:a}),c.finish()}function je(e){let t=new _;return se({...e,writer:t}),t.getBuffer()}return tt(qt);})();
